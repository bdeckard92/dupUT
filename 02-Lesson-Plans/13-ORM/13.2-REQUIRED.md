# Module 13 Virtual Class: Object Relational Mapping (ORM)

## Overview

In today's virtual class, students will learn how to use the Object Relational Mapping (ORM) to connect to and query a database. Students also learn how to add validations to their models, create one-to-one and one-to-many relationships, and use the include clause to limit the data returned from the database.

## Learning Objectives

By the end of class, students will be able to:

* Add validations to models

* Use Sequelize CRUD methods in routes

* Create relationships between models

* Make queries using the Sequelize `include` option

## Instructor Notes

* At the beginning of today‚Äôs class, please remind students to complete the **Midpoint Survey** that covers their journey thus far. It‚Äôs important that they are aware of this in advance and that they take their time to complete the survey. This will ultimately help us understand how the program, the curriculum, the instruction, and our support can be improved!

* Be sure to prepare and read over the activities before your class begins. Try to anticipate any questions students may have.

* During activities, visit a few breakout rooms quietly and ask the group if they are comfortable with the activity and provide gentle tips to keep them on track.

* Make sure you change all of the connection information so the examples have your MySQL username/password!

* If you don't want to do it live in class, create the databases required for today's exercises before class.

* BE VERY CAREFUL NOT TO GO TOO IN DEPTH. There are a ton of components that make Sequelize work, but much of it is boilerplate that doesn't need much explanation.

* THIS IS TOUGH STUFF! This week, tell your class to not feel discouraged if there are concepts that they can't nail down completely. Tell them to try their best, but to speak with you or a TA if they're unsure of anything.

* Lesson 1 and 3 covered the basic CRUD methods, Lesson 4 and 5 went into associations and eager loading.

## Office Hours

Encourage students to work on the remaining module algorithms during Office Hours. Review the algorithm solutions 5‚Äì10 minutes before class begins or during Office Hours after class.

## Time Tracker

| Start  | #   | Activity Name                    | Duration |
| ------ | --- | -------------------------------- | -------- |
| 6:30PM | 0   | Office Hours                     | 0:30     |
| 7:00PM | 1   | Introduction                     | 0:10     |
| 7:10PM | 2   | Review Current Challenge         | 0:05     |
| 7:15PM | 3   | Instructor Demo: Update-Delete   | 0:05     |
| 7:20PM | 4   | Student Do: Update-Delete        | 0:25     |
| 7:45PM | 5   | Instructor Review: Update-Delete | 0:10     |
| 7:55PM | 6   | Instructor Demo: One-to-one      | 0:05     |
| 8:00PM | 7   | Student Do: One-to-one           | 0:10     |
| 8:10PM | 8   | Instructor Review: One-to-one    | 0:10     |
| 8:20PM | 9   | Instructor Demo: One-to-many     | 0:05     |
| 8:25PM | 10  | Student Do: One-to-many          | 0:15     |
| 8:40PM | 11  | Instructor Review: One-to-many   | 0:10     |
| 8:50PM | 12  | Recap & Promote Resources        | 0:05     |
| 8:55PM | 13  | Introduce Upcoming Challenge     | 0:05     |
| 9:00PM | 14  | End                              | N/A      |

---

## Class Instructions

### 1. Introduction (10 min)

* Welcome students to class.

* Remind students to complete the Midpoint Survey to help us understand how the program, the curriculum, the instruction, and our support can be improved. Clarify that this survey is **not** about the current Module, but is about the entire course up until this point!

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What did you learn this week? How would you explain it to your friends and family?

  * üôã We learned about Sequelize, which is a promise-based Node.js ORM for MySQL. We are moving fast compared to traditional learners. It‚Äôs okay to feel overwhelmed as long as you don‚Äôt give up.

  * ‚òùÔ∏è Did anyone have an "Aha!" or "Eureka!" moment this week? When was it and why did things suddenly click for you?

  * üôã Eureka moments happen when we try different approaches to a problem or change the way we're thinking about it.

  * ‚òùÔ∏è Did anyone feel stuck this week? How did you get unstuck?

  * üôã It's easy to get stuck when you're learning web development. It's important to learn how to get unstuck because it happens to the pros too. Rather than getting lost in search results, consult the tool's official documentation first. Then ask for help from instructional staff or your peers. Study groups are great because explaining your problems to someone else often reveals the solution.

### 2. Review Current Challenge (5 min)

* Navigate to `02-Challenge/Main/` from the command line and run `node server.js`.

* Open <http://localhost:3001/api/products> in a browser and demonstrate the following:

  * You're going to build the API routes for a products database.

  * Products belong to a category and can have many tags each.

  * You'll be using an ORM called Sequelize to help you define your data's relationships and help you to execute complicated queries.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What recently acquired skills will help us build this challenge?

  * üôã We will be using Sequelize as our ORM for this application. We utilized the CRUD methods to query our products database and well as the tags.

  * ‚òùÔ∏è How are these skills relevant to a career in web development?

  * üôã Professional applications rely on ORMs to make the data easier to define and understand. ORMs also implement many safeguards for us to prevent bad or malicious data.

  * ‚òùÔ∏è How will this challenge improve your portfolio?

  * üôã It will demonstrate a firm understanding of databases and ORMs.

* Answer any questions before proceeding to the next activity.

### 3. Instructor Demo: Update-Delete (5 min)

* Navigate to `03-Update-Delete/` from the command line and run the following command to ensure that the `library_db` database has been created:

  ```bash
  mysql -u root -p < db/schema.sql
  ```

* Navigate to `03-Update-Delete` in your command line and be sure to change the `.env.EXAMPLE` file into your own `.env` file with your credentials.

* Next, run `npm i` and `npm start` from the command line to install the dependencies and start the server.

* In Insomnia, create a new POST request to `/api/books/seed` to make sure that the database is populated with seed data.

* Using Insomnia, execute the following queries to demonstrate the CRUD methods:

  * üîë Get all books from the database.
  
  * üîë Update one of the properties on a book by using the id to find it.

  * üîë Delete a book by id.

  * üîë Note that in this activity, we are focusing only on the update and delete methods.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Where have we used this before?

  * üôã We used `update` and `delete` methods in our `User` model in Lesson 1 and in our `Post` model in Lesson 3.

  * ‚òùÔ∏è How does this activity equip us for the Challenge?

  * üôã We will need to use methods to query the products database.

  * ‚òùÔ∏è How would we build this?

  * üôã We need to use Sequelize CRUD methods in the appropriate routes.

* Answer any questions before proceeding to the next activity.

### 4. Student Do: Update-Delete  (15 min)

* Divide students into breakout rooms.

* Direct students to the activity instructions found in `03-Update-Delete/README.md`.

```md
# üèóÔ∏è Implement the PUT and DELETE Route with Your Own Parameters

Work with a partner to implement the following user story:

* As a bookstore owner, I want to be able to update and remove certain books of my choice from the inventory.

## Acceptance Criteria

* It's done when a book is updated with new information (like 'numberOfPages').

* It's done when a book can be deleted based on specific parameters (like 'book_id').

---

## üí° Hints

Which option do you need to use on the method call?

## üèÜ Bonus

If you have completed this activity, work through the following challenge with your partner to further your knowledge:

* What SQL operators does Sequelize support?

Use [Google](https://www.google.com) or another search engine to research this.

---
¬© 2021 Trilogy Education Services, LLC, a 2U, Inc. brand. Confidential and Proprietary. All Rights Reserved.
```

### 5. Instructor Review: Update-Delete  (10 min)

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with the UPDATE and DELETE methods in Sequelize? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è `update()`

  * ‚úîÔ∏è `destroy()`

  * ‚úîÔ∏è `WHERE`

* Open `03-Update-Delete/Solved/routes/api/bookRoute.js` in your IDE and explain the following:

  * üîë Use the `update()` method on the `Book` model, mapping the request body to the proper fields in the database, as follows:

    ```js
    router.put('/:book_id', (req, res) => {
      Book.update(
      {
        title: req.body.title,
        author: req.body.author,
        isbn: req.body.isbn,
        pages: req.body.pages,
        edition: req.body.edition,
        is_paperback: req.body.is_paperback,
      },
    ```

  * üîë We add optional parameters to the `update()` method to specify which book we want to update with the `WHERE` clause. We use the request parameters to retrieve the `book_id` of the desired book, as follows:

    ```js
    where: {
      book_id: req.params.book_id,
    },
    ```

  * We then send the response with the updated book or catch any errors that might occur, as shown in the following example:

    ```js
    .then((updatedBook) => {
        res.json(updatedBook);
      })
      .catch((err) => {
        console.log(err);
        res.json(err);
      });
    ```

  * üîë Inside the DELETE route, use the `destroy()` method on the `Book` model. We use the `WHERE` clause to filter the book we want to delete from the database, as follows:

    ```js
    router.delete('/:book_id', (req, res) => {

    Book.destroy({
      where: {
        book_id: req.params.book_id,
      },
    })
      .then((deletedBook) => {
        res.json(deletedBook);
      })
      .catch((err) => res.json(err));
    });
    ```

* üîë Point out how Express.js uses the `delete` keyword for DELETE routes but Sequelize uses the `destroy` keyword. This easy mistake can prevent your route from working properly.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What does the `WHERE` clause do?

  * üôã Helps us specify where in the database we want to look.

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [Sequelize documentation on model querying basics](https://sequelize.org/master/manual/model-querying-basics.html), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 6. Instructor Demo: One-to-One  (5 min)

* Be sure to have already run `npm install` and modified the `connection.js` file to include your MySQL user/password information. Otherwise, walk through it with the class.

* Navigate to `04-Blog-Association/Solved/` in your command line and run `npm start`. Open your MySQL Workbench and demonstrate the following:

  * üîë The `Post` table now has a foreign key of `AuthorId`

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Where have we used this before?

  * üôã We learned about foreign keys and "through" tables when we created the Vote Model that connected the Post and User Models in Lesson 4.

  * ‚òùÔ∏è How does this activity equip us for the challenge?

  * üôã Our products will belong to a category and can have many tags each. These will all involve associations which is what we're practicing here.

  * ‚òùÔ∏è How would we build this?

  * üôã We need to create relationships between the `Post` and `Author` models.

* Answer any questions before proceeding to the next activity.

### 7. Student Do: One-to-One  (15 min)

* **Let students know that this activity is shorter and will be given only 10 minutes to complete**

* Divide students into breakout rooms.

* Direct students to the activity instructions found in `04-Blog-Association/README.md`.

    ```md
    # Blog Association

    In this activity, you will create relationships between the `Post` and `Author` models so that they are associated with each other. 

    ## Instructions

    * Navigate to the [Unsolved](Unsolved/) folder and run `npm install` in your terminal.

    * Be sure to modify the [connection.js](Unsolved/app/config/connection.js) file to include your MySQL user/password information.

    * Open the [index.js](Unsolved/models/index.js) file and create the following associations:

      * Create a relationship that instructs the `Post` to belong to `Author`.

      * Create a relationship that instructs `Author` that it has many `Post`.

    ## Hint(s)

    * You may need to consult the [Sequelize Manual on Associations](https://sequelize.org/v5/manual/associations.html) on how to make relationships between the models. 
    ```

### 8. Instructor Review: One-to-One  (10 min)

* Bring students back from breakout rooms.

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è `belongsTo` association

  * ‚úîÔ∏è `hasMany` association

* Open `04-Blog-Association/Solved/models/index.js` in your IDE and explain the following:

  * Sequelize provides four types of associations of which we will use the `belongsTo` and `hasMany` associations.

  * üîë We need to create a relationship that instructs the `Post` to belong to an `Author`.

  * `Post` is the source model and the foreign key will be defined in it.

    ```js
    Post.belongsTo(Author);
    ```

  * üîë We need to create a relationship that instructs `Author` that it has many `Post`.

  * Here `Post` is the target model with the foreign key.

    ```js
    Author.hasMany(Post);
    ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è In our case where we use `hasMany` and `belongsTo` associations together, what is this relationship called?

  * üôã This kind of relationship is called `One-to-Many`. There are also `One-to-One` relationships and `Many-to-Many` relationships.

  * ‚òùÔ∏è What can you do if you don't completely understand this?

  * üôã We can refer to Lesson 4, read the [Sequelize Manual on Associations](https://sequelize.org/v5/manual/associations.html), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 9. Instructor Demo: One-to-Many  (5 min)

* Be sure to have already run `npm install` and modified the `connection.js` file to include your MySQL user/password information. Otherwise, walk through it with the class.

* Navigate to `05-Blog-Joins/Solved/` in your command line and run `npm start`.

* Navigate to <http://localhost:3001/> in your browser and demonstrate the following:

  * üîë We can create authors now! Create a few authors.

  * üîë Create a few posts for each author.

* Navigate to <http://localhost:3001/api/posts> and <http://localhost:3001/api/authors> in your browser and show the JSON returned for both routes:

  * üîë They should include all of the post and author's information together.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Where have we used this before?

  * üôã Again, we learned about these associations when we created the Vote Model that connected the Post and User Models in Lesson 4 and 5.

  * ‚òùÔ∏è How does this activity equip us for the challenge?

  * üôãSince the products belong to a category and can have many tags each, they may need to use the `include` option in the GET routes.

  * ‚òùÔ∏è How would we build this?

  * üôã We need to use Sequelize's "include" option in the queries we make in the GET routes.

* Answer any questions before proceeding to the next activity.

### 10. Student Do: One-to-many  (20 min)

* **Let students know that this activity is shorter and will be given only 15 minutes to complete**

* Divide students into breakout rooms.

* Direct students to the activity instructions found in `05-Blog-Joins/README.md`.

```md
# Blog Joins

In this activity, you will modify the queries in both `post-api-routes.js` and `author-api-routes.js` to use the Sequelize "include" option.

## Instructions

* Navigate to the [Unsolved](Unsolved/) folder and run `npm install` in your terminal.

* Be sure to modify the [connection.js](Unsolved/config/connection.js) file to include your MySQL user/password information.

* Open the [post-api-routes.js](Unsolved/routes/api/post-api-routes.js) file.

  * Add the "include" option to the queries specified in the comments. We want to "include" the Author model. 

* Open the [author-api-routes.js](Unsolved/routes/api/author-api-routes.js) file.

  * Add the "include" option to the queries specified in the comments. We want to "include" the Post model. 

* To test if everything is working properly, run `npm start` in your terminal and navigate to <http://localhost:3001/> in your browser. 

  * After creating a few Authors with a few Posts each, navigate to either <http://localhost:3001/api/posts> or <http://localhost:3001/api/authors> to make sure the JSON returned for both routes includes all of the data.

## Hint(s) 

* The "include" key goes on the same options object as the "where" attribute we've been using. 

* Note how we are requiring the models in order to set the correct value of the "include" option.
```

### 11. Instructor Review: Blog Joins  (10 min)

* Bring students back from breakout rooms.

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è `include` the Author model

  * ‚úîÔ∏è `include` the Post model

* Open `05-Blog-Joins/Solved/routes/api/post-api-routes.js` in your IDE and explain the following:

  * üîë We need to add the `include` property to our options in the `findAll()` query. We set the value to an array of the models we want to include in a left outer join, which is `db.Author`:

    ```js
    router.get('/', (req, res) => {
      const query = {};
      if (req.query.author_id) {
        query.AuthorId = req.query.author_id;
      }

      db.Post.findAll({
        where: query,
        include: [db.Author]
      }).then(dbPost => {
        res.json(dbPost);
      });
    });
    ```

  * We need to add another `include` property to our options in the `findOne()` query:

    ```js
    router.get('/:id', (req, res) => {
      db.Post.findOne({
        where: {
          id: req.params.id
        },
        include: [db.Author]
      }).then(dbPost => {
        res.json(dbPost);
      });
    });
    ```

* Open `05-Blog-Joins/Solved/routes/api/author-api-routes.js` in your IDE and explain the following:

  * We need to do the same thing to our `Author` routes.

  * üîë We need to add the `include` property to our options in the `findAll()` query. We set the value to an array of the models we want to include in a left outer join, which is `db.Post`:

    ```js
    router.get('/', (req, res) => {
      db.Author.findAll({
        include: [db.Post]
      }).then(dbAuthor => {
        res.json(dbAuthor);
      });
    });
    ```

  * Finally we need to add an `include` property to our options in the `findOne()` query:

    ```js
    router.get('/:id', (req, res) => {
      db.Author.findOne({
        where: {
          id: req.params.id
        },
        include: [db.Post]
      }).then(dbAuthor => {
        res.json(dbAuthor);
      });
    });
    ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What is eager loading?

  * üôã Eager loading is when you query data of several models at once (one 'main' model and one or more associated models). At the SQL level, this is a query with one or more joins. In Sequelize, eager loading is mainly done by using the `include` option on a model finder query (such as `findOne`, `findAll`, etc).

  * ‚òùÔ∏è What can you do if you don't completely understand this?

  * üôã We can refer to Lesson 4, read the [Sequelize Manual on Eager Loading](https://sequelize.org/master/manual/eager-loading.html), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 12. Recap & Promote Additional Resources (5 min)

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What do you think you absolutely need to know to succeed at the challenge?

  * üôã We need to know Sequelize CRUD methods as well as how to make relationships between the models.

  * ‚òùÔ∏è What do you think is okay to not completely understand?

  * üôã All of it! The field of web development is very wide and rapidly evolving. Unless you choose to specialize, it is not necessary to know any one area completely to be successful.

  * ‚òùÔ∏è Why is it important to do as much of the lesson material prior to class as possible?

  * üôã It's important both to be fully prepared to start the challenge and because it will prepare you for your future career as a web developer. We cover a lot of material in the boot camp. Lessons are intentionally designed to give each topic an optimal amount of depth and scope so that you have a solid foundation to build upon in future lessons. The skills you learn in the lessons are cutting-edge, real-world skills that you will use in your career as a full-stack web developer.

* Direct students to the additional resources available to them:

  * Reflection and Retrieval

  * Career Connection

  * Dessert Menu

### 13. Introduce Upcoming Challenge (5 min)

* Navigate to `01-Class-Content/14-MVC/02-Challenge/Main` from the command line and run `node server.js`

* Open <http://localhost:3001/> and demonstrate the following:

  * You are going to build a CMS-style blog site where you can write posts.

  * You will need to sign up or sign in in order to access any other links in the navigation.

  * When you click on a post, you can leave a comment. You can also write a new post, update it, or delete it.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What are we learning?

  * üôã We are implementing authentication as well as using template engines to render our views.

  * ‚òùÔ∏è How does this project build off or extend previously learned material?

  * üôã We are continuing to use Express.js and Sequelize in this application.

  * ‚òùÔ∏è How does this project relate to your career goals?

  * üôã User authentication and sessions are critical parts to building secure applications.

* Answer any questions before proceeding to the next activity.

### 14. End

How did today‚Äôs lesson go? Your feedback is important. Please take 5 minutes to complete [this anonymous survey](https://forms.gle/3LozVjherGH83aG17).

---
¬© 2021 Trilogy Education Services, LLC, a 2U, Inc. brand.  Confidential and Proprietary.  All Rights Reserved.
