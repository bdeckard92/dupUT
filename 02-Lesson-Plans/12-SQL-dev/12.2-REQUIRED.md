# Module 12 Virtual Class: SQL

## Overview 

In today's virtual class, students will review constraints, `JOIN` statements, and `?` prepared statements.

## Learning Objectives

By the end of class, students will be able to:

* Specify the relationship between tables using Primary and Foreign Keys

* Write a SQL query that joins two tables together

* Implement `?` prepared statements in conjunction with `INSERT`, `UPDATE`, and `DELETE`

## Instructor Notes 

* At the beginning of today’s class, please let students know they will be prompted to complete a **Midpoint Survey** that covers their journey thus far. It’s important that they are aware of this in advance and that they take their time to complete the survey. This will ultimately help us understand how the program, the curriculum, the instruction, and our support can be improved!

* Be sure to prepare and read over the activities before your class begins. Try to anticipate any questions students may have.

* Be prepared to provide your MySQL password after you enter `mysql -uroot -p`. 

* By now, students should have installed MySQL on their machines. If not, direct them to the "Up and Running" content in the async material for instructions.

* After starting up the MySQL server, make sure the students can initialize the MySQL command line prompt: `mysql -u root -p`. They will need their MySQL password.

  * Some MacOS users may find that this doesn't work and get the error message, "command not found". Students may need to add the following into their `.bash_profile` or `.zshrc` file:
 
    `export PATH="${PATH}:/usr/local/mysql/bin/"`

  * For Windows users, they can refer to [this documentation](https://dev.mysql.com/doc/mysql-windows-excerpt/5.7/en/mysql-installation-windows-path.html) if they also get the error.

* During activities, visit a few breakout rooms and check if the students have installed MySQL correctly and are able to do the activities without technical difficulties. 

* In the async material, students are introduced to the `mysql2` npm package and prepared statements in Lesson 2 when students create API routes for their candidate data. In Lesson 3, they learn about `JOIN` statements to merge candidate data with party data.

## Office Hours

Encourage students to work on the remaining module algorithms during office hours. Review the algorithm solutions 5–10 minutes before class begins or during office hours after class.


## Time Tracker 

| Start  | #   | Activity Name                          | Duration |
| ------ | --- | ----------------------------           | -------- |
| 6:30PM | 0   | Office Hours                           | 0:30     |
| 7:00PM | 1   | Introduction                           | 0:10     |
| 7:10PM | 2   | Review Current Challenge               | 0:05     |
| 7:15PM | 3   | Instructor Demo: Constraints           | 0:05     |
| 7:20PM | 4   | Student Do: Constraints                | 0:15     |
| 7:35PM | 5   | Instructor Review: Constraints         | 0:10     |
| 7:45PM | 6   | Instructor Demo: Joins                 | 0:05     |
| 7:50PM | 7   | Student Do: Joins                      | 0:15     |
| 8:05PM | 8   | Instructor Review: Joins               | 0:10     |
| 8:15PM | 9   | Instructor Demo: Prepared Statements   | 0:05     |
| 8:20PM | 10  | Student Do: Prepared Statements        | 0:20     |
| 8:40PM | 11  | Instructor Review: Prepared Statements | 0:10     |
| 8:50PM | 12  | Recap & Promote Resources              | 0:05     |
| 8:55PM | 13  | Introduce Upcoming Challenge           | 0:05     |
| 9:00PM | 14  | Office Hours                           | 0:30     |
| 9:30PM | 15  | End                                    | N/A      |

---

## Class Instructions

### 1. Introduction (10 min)

* Welcome students to class.

* Remind students to complete the Midpoint Survey to help us understand how the program, the curriculum, the instruction, and our support can be improved. Clarify that this survey is **not** about the current Module, but is about the entire course up until this point!

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

    * ☝️ What did you learn this week? How would you explain it to your friends and family?

    * 🙋 We learned what foreign keys are, how to use `JOIN` statements, and how to connect to a SQL database from Node. We are moving fast compared to traditional learners. It’s okay to feel overwhelmed as long as you don’t give up.

    * ☝️ Did anyone have an "Aha!" or "Eureka!" moment this week? When was it and why did things suddenly click for you? 

    * 🙋 Eureka moments happen when we try different approaches to a problem or change the way we're thinking about it.

    * ☝️ Did anyone feel stuck this week? How did you get unstuck?

    * 🙋 It's easy to get stuck when you're learning web development. It's important to learn how to get unstuck because it happens to the pros too. Rather than getting lost in search results, consult the tool's official documentation first. Then ask for help from instructional staff or your peers. Study groups are great because explaining your problems to someone else often reveals the solution. 


### 2. Review Current Challenge (5 min)

* Navigate to `02-Challenge/Main/` from the command line and run `node index.js` to demonstrate the following: 

    * When we select "View All Employees," we see the contents of the `employees` table combined with data from other tables.

    * When we select "Add Employee," we can input different data points to insert a new record in the table.

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

    * ☝️ What recently acquired skills will help us build this challenge?

    * 🙋 SQL statements like `SELECT`, `INSERT`, and `JOIN` and SQL-related npm packages.

    * ☝️ How are these skills relevant to a career in web development?

    * 🙋 The majority of business apps are going to need a database!

    * ☝️ How will this challenge improve your portfolio?

    * 🙋 A database-driven app will lend to bigger, more impressive portfolio pieces.

* Answer any questions before proceeding to the next activity.


### 3. Instructor Demo: SQL JOIN (5 min) 

* Navigate to `04-SQL-Join/Solved/` in the command line and demonstrate the following:

  * 🔑 We initialize the MySQL command line by typing `mysql -u root -p` and your MySQL password. Be sure your MySQL Server is running!

  * 🔑 We set up the database by typing `source db/schema.sql` in the MySQL command line.

  * 🔑 We seed the database by typing `source db/seeds.sql`.

  * 🔑 We join the `prices` and `books` data together by executing a query using the MySQL shell using `SOURCE db/query.sql`.

  * 🔑 If our join is successful, the price for each book will appear in the table.     

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

    * ☝️ Where have we used this before?

    * 🙋 We used this to join `candidates` with their `party affiliation` in Lesson 3.

    * ☝️ How does this activity equip us for the challenge?

    * 🙋 We will need to use `JOIN` to combine employee data with other tables, like their departments.

    * ☝️ How would we build this?

    * 🙋 First, we will use primary and foreign keys to set a relationship between the tables. Then, we will write a query that uses the `JOIN` clause. 

* Answer any questions before proceeding to the next activity.


### 4. Student Do: SQL JOIN  (15 min) 

* Divide students into breakout rooms.

* Direct students to the activity instructions found in `03-SQL-JOIN/README.md`.

  ```md
  # 📐 Add Comments to Implementation of a MySQL JOIN Clause

  Add comments describing the functionality of the code found in [Unsolved](./Unsolved).

  ## 📝 Notes

  Refer to the documentation: 

  [MySQL Docs on JOIN Clause](https://dev.mysql.com/doc/refman/8.0/en/join.html)

  ---

  ## 🏆 Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How do we define a relationship between the two tables?

  Use [Google](https://www.google.com) or another search engine to research this.

  --- 
  ```
  
### 8. Instructor Review: SQL JOIN  (10 min) 

* Bring students back from breakout rooms. 

* Use the prompts and talking points below to review the following key (🔑) points:

  * ✔️ `SELECT` COLUMN `AS`

  * ✔️ `JOIN` clause

  * ✔️ `ON` clause

* Open `04-SQL-Join/Solved/db/qyery.sql` in your IDE and explain the following: 

  * 🔑 We select the columns we want to appear in our joined table by using the `SELECT` command. Since, we are working with two tables, we use dot notation to put the name of the table, followed by the name of the field.

    ```sql
    SELECT
    books.book_name
    ```
  
  * 🔑 We use the `AS` clause to rename our columns. This name will appear as the column name at the top of the table. 

    ```sql
    SELECT
    books.book_name AS book_name, prices.price AS price
    ```
  
  * We use `FRON` to select the `books` table. The `books` table references the `price` table with a foreign key. 

    ```sql
    FROM books
    ```
    
  * 🔑 We then join the price table using the `JOIN` clause.

    ```sql
    JOIN prices 
    ```
    
   * 🔑 We use the `ON` clause to show the relationship between the two tables. In our `schema`, the `bboks` price column references the `prices` id column.
   
     ```sql
     JOIN prices ON books.price = prices.id;
     ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ What's the purpose of a `JOIN` clause?

  * 🙋 To combine data from two different but related tables.

  * ☝️ Why is it important to include an `ON` clause?

  * 🙋 The `ON` clause specifies the relationship between the tables we want to join. 

  * ☝️ What can you do if you don't completely understand this?

  * 🙋 We can refer to Lesson 3, read the [MySQL docs on the JOIN clause](https://dev.mysql.com/doc/refman/5.7/en/join.html), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.


### 9. Instructor Demo: Ice Cream CRUD  (5 min) 

* Navigate to `05-Ice-Cream-CRUD/Solved` in your command line and run `npm install` and `npm start` to demonstrate the following:

  * 🔑 The app connects to the same `ice_creamDB` database from the previous activity.

  * 🔑 The app performs an `INSERT`, `UPDATE`, `DELETE`, and `SELECT` query in sequential order.

  * First, we insert a new product:

    ```
    Inserting a new product...

    INSERT INTO products SET `flavor` = 'Rocky Road', `price` = 3, `quantity` = 50
    1 product inserted!
    ```

  * Then we update the quantity of one product:

    ```
    Updating all Rocky Road quantities...

    UPDATE products SET `quantity` = 100 WHERE `flavor` = 'Rocky Road'
    1 products updated!
    ```

  * Next we delete one product:

    ```
    Deleting all strawberry ice cream...

    DELETE FROM products WHERE `flavor` = 'strawberry'
    1 products deleted!
    ```

  * Finally we print out all of the current products in the database:

    ```
    Selecting all products...

    [
      TextRow { id: 1, flavor: 'vanilla', price: '2.50', quantity: 100 },
      TextRow { id: 2, flavor: 'chocolate', price: '3.10', quantity: 120 },
      TextRow { id: 4, flavor: 'Rocky Road', price: '3.00', quantity: 100 }
    ]
    ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

    * ☝️ Where have we used this before?

    * 🙋 We used database queries for CRUD operations to build API routes in Lessons 2-5. Prepared statements were first introduced in Lesson 2.

    * ☝️ How does this activity equip us for the challenge?

    * 🙋 The Employee Tracker performs various CRUD operations.

    * ☝️ How would we build this?

    * 🙋 We can use the `.query()` and prepared statements to execute CRUD operations with SQL queries.

* Answer any questions before proceeding to the next activity.


### 10. Student Do: Ice Cream CRUD  (20 min) 

* Divide students into breakout rooms.

* Direct students to the activity instructions found in `05-Ice-Cream-CRUD/README.md`.

  ```md
  # Ice Cream CRUD

  In this activity, you will write functions that will query the database to perform CRUD operations. 

  ## Instructions

  * In the [connection.js](Unsolved/db/connection.js) file, update the `password` with your MySQL password. The `schema.sql` and `seeds.sql` files have been included in the `db` folder in case you need to reset the database.

  * Open the [server.js](Unsolved/server.js) file.

    * Examine the `createProduct()` function and use as a reference to write the following functions to UPDATE, DELETE, and READ data in the `ice_creamDB` database. 

    * Update the quantity for `Rocky Road` to 100

    * Delete the flavor `strawberry`

    * Read all of the data from the `products` table

    * Remember to include the callback functions!

  * To check if everything was done correctly, run `npm install` and `npm start` in the command line. 

  ## Hint(s)

  * Use the prepared statements for the UPDATE and DELETE operations.
  ```

### 11. Instructor Review: Ice Cream CRUD  (10 min) 

* Bring students back from breakout rooms. 

* Use the prompts and talking points below to review the following key (🔑) points:

  * ✔️ `?` prepared statements

  * ✔️ Asynchronous callbacks

* Open `05-Ice-Cream-CRUD/Solved/server.js` in your IDE and explain the following: 

  * We call the `createProduct()` function after the database connection is successful:

    ```js
    db.connect(err => {
      if (err) throw err;
      console.log('connected as id ' + db.threadId + '\n');
      createProduct();
    });
    ```

  * 🔑 In `createProduct()`, we use a `?` placeholder in the query and fill in the data later with a second object argument:

    ```js
    createProduct = () => {
      console.log('Inserting a new product...\n');
      const query = db.query(
        'INSERT INTO products SET ?',
        {
          flavor: 'Rocky Road',
          price: 3.0,
          quantity: 50
        },
    ```

  * 🔑 We call the next `updateProduct()` function from within the callback function to ensure it happens AFTER the insertion is complete:

    ```js
    (err, res) => {
      if (err) throw err;
      console.log(res.affectedRows + ' product inserted!\n');
      // Call updateProduct() AFTER the INSERT completes
      updateProduct();
    }
    ```

  * We save the return value of `connection.query()` to a variable, so we can verify what the final query actually looks like:

  ```js
  console.log(query.sql);
  ```

  * 🔑 In `updateProduct()`, we use two `?` placeholders, so the second argument is an array of objects:

    ```js
    updateProduct = () => {
      console.log('Updating all Rocky Road quantities...\n');
      const query = db.query(
        'UPDATE products SET ? WHERE ?',
        [
          {
            quantity: 100
          },
          {
            flavor: 'Rocky Road'
          }
        ],
    ```

  * In the callback function, we call the next function in the process, `deleteProduct()`, after the update completes:

  ```js
  (err, res) => {
    if (err) throw err;
    console.log(res.affectedRows + ' products updated!\n');
    // Call deleteProduct() AFTER the UPDATE completes
    deleteProduct();
  }
  ```

  * In `deleteProduct()`, we use a single `?` placeholder again for the `WHERE` clause and call the last function, `readProducts()`, in the callback:

    ```js
    deleteProduct = () => {
      console.log('Deleting all strawberry ice cream...\n');
      const query = db.query(
        'DELETE FROM products WHERE ?',
        {
          flavor: 'strawberry'
        },
        (err, res) => {
          if (err) throw err;
          console.log(res.affectedRows + ' products deleted!\n');
          // Call readProducts() AFTER the DELETE completes
          readProducts();
        }
    ```

  * Finally, in `readProducts()`, we select all the data and log it into the console. 

  ```js
  readProducts = () => {
    console.log('Selecting all products...\n');
    db.query('SELECT * FROM products', (err, res) => {
      if (err) throw err;
      // Log all results of the SELECT statement
      console.log(res);
      db.end();
    });
  };
  ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ Why would we want to use prepared statements?

  * 🙋 The syntax can be easier to read/write; it protects us against SQL injection.

  * ☝️ When using prepared statements, how can you verify the actual SQL query being run?

  * 🙋 Save the return value in a variable and log it in the console.

  * ☝️ What can you do if you don't completely understand this?

  * 🙋 We can refer to Lesson 2, read the MySQL2 documentation on [using prepared statements](https://www.npmjs.com/package/mysql2#using-prepared-statements), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 12. Recap & Promote Additional Resources (5 min)

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ What do you think you absolutely need to know to succeed at the challenge?

  * 🙋 We will need to know how to join tables together and how to connect to a MySQL database from Node.

  * ☝️ What do you think is okay to not completely understand?

  * 🙋 All of it! The field of web development is very wide and rapidly evolving. Unless you choose to specialize, it is not necessary to know any one area completely to be successful. 

  * ☝️ Why is it important to do as much of the lesson material prior to class as possible?

  * 🙋 It's important both to be fully prepared to start the challenge and because it will prepare you for your future career as a web developer. We cover a lot of material in the boot camp. Lessons are intentionally designed to give each topic an optimal amount of depth and scope so that you have a solid foundation to build upon in future lessons. The skills you learn in the lessons are cutting-edge, real-world skills that you will use in your career as a full-stack web developer.

* Direct students to the additional resources available to them:

  * Reflection and Retrieval

  * Career Connection

  * Dessert Menu

### 13. Introduce Upcoming Challenge (5 min)

* Navigate to `01-Class-Content/13-ORM/02-Challenge/Main/` from the command line and run `node server.js`.

* Open <http://localhost:3001/api/products> in a browser and demonstrate the following: 

    * You're going to build the API routes for a products database.

    * Products belong to a category and can have many tags each.

    * You'll be using an ORM called Sequelize to help you define your data's relationships and help you to execute complicated queries.

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

    * ☝️ What are we learning?

    * 🙋 We are learning about ORMs (and in particular, Sequelize).

    * ☝️ How does this project build off or extend previously learned material?

    * 🙋 We'll continue using SQL but in a more complicated context.

    * ☝️ How does this project relate to your career goals?

    * 🙋 Professional applications rely on ORMs, like Sequelize, to make the data easier to define and understand. ORMs also implement many safeguards for us to prevent bad or malicious data.

* Answer any questions before proceeding to the next activity.

### 14. Office Hours (30 min)

* Announce office hours and encourage students to stay on the Zoom and start the challenge while they have live support from instructional staff. 


### 15. End 

How did today’s lesson go? Your feedback is important. Please take 5 minutes to complete [this anonymous survey](https://forms.gle/3LozVjherGH83aG17)

---
© 2021 Trilogy Education Services, LLC, a 2U, Inc. brand.  Confidential and Proprietary.  All Rights Reserved.
